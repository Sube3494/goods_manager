generator client {
  provider = "prisma-client-js"
  output   = "./generated-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  SUPER_ADMIN
}

model Workspace {
  id                 String              @id @default(cuid())
  name               String              @default("My Workspace")
  ownerId            String              @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  brushOrders        BrushOrder[]
  categories         Category[]
  galleryItems       GalleryItem[]
  gallerySubmissions GallerySubmission[]
  outboundOrders     OutboundOrder[]
  products           Product[]
  purchaseOrders     PurchaseOrder[]
  suppliers          Supplier[]
  systemSettings     SystemSetting[]
  users              User[]              @relation("WorkspaceMembers")
  owner              User                @relation("WorkspaceOwner", fields: [ownerId], references: [id])
}

model Category {
  id          String     @id @default(cuid())
  name        String
  description String?
  workspaceId String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])
  products    Product[]

  @@unique([name, workspaceId])
  @@index([workspaceId])
}

model Product {
  id              String              @id @default(cuid())
  sku             String?
  name            String
  costPrice       Float               @default(0)
  stock           Int                 @default(0)
  image           String?
  isPublic        Boolean             @default(true)
  specs           Json?
  categoryId      String
  supplierId      String?
  workspaceId     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  brushOrderItems BrushOrderItem[]
  gallery         GalleryItem[]
  outboundItems   OutboundOrderItem[]
  category        Category            @relation(fields: [categoryId], references: [id])
  supplier        Supplier?           @relation(fields: [supplierId], references: [id])
  workspace       Workspace?          @relation(fields: [workspaceId], references: [id])
  orderItems      PurchaseOrderItem[]

  @@unique([sku])
  @@index([categoryId])
  @@index([supplierId])
  @@index([workspaceId])
}

model Supplier {
  id                 String              @id @default(cuid())
  code               String?
  name               String
  contact            String?
  phone              String?
  email              String?
  address            String?
  workspaceId        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  products           Product[]
  purchaseOrderItems PurchaseOrderItem[]
  workspace          Workspace?          @relation(fields: [workspaceId], references: [id])

  @@unique([code, workspaceId])
  @@index([workspaceId])
}

model PurchaseOrder {
  id              String              @id @default(cuid())
  type            String              @default("Purchase")
  status          String              @default("Draft")
  totalAmount     Float               @default(0)
  date            DateTime            @default(now())
  shippingFees    Float               @default(0)
  extraFees       Float               @default(0)
  paymentVouchers Json?               @default("[]")
  trackingData    Json?               @default("[]")
  note            String?
  workspaceId     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  workspace       Workspace?          @relation(fields: [workspaceId], references: [id])
  items           PurchaseOrderItem[]

  @@index([workspaceId])
}

model PurchaseOrderItem {
  id                String        @id @default(cuid())
  purchaseOrderId   String
  productId         String
  supplierId        String?
  quantity          Int
  remainingQuantity Int?
  costPrice         Float
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  product           Product       @relation(fields: [productId], references: [id])
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  supplier          Supplier?     @relation(fields: [supplierId], references: [id])
}

model OutboundOrder {
  id          String              @id @default(cuid())
  type        String              @default("Sale")
  date        DateTime            @default(now())
  note        String?
  status      String              @default("Normal")
  workspaceId String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  workspace   Workspace?          @relation(fields: [workspaceId], references: [id])
  items       OutboundOrderItem[]

  @@index([workspaceId])
}

model OutboundOrderItem {
  id              String        @id @default(cuid())
  outboundOrderId String
  productId       String
  quantity        Int
  price           Float         @default(0)
  outboundOrder   OutboundOrder @relation(fields: [outboundOrderId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])
}

model GalleryItem {
  id          String     @id @default(cuid())
  url         String
  productId   String
  tags        String[]   @default([])
  isPublic    Boolean    @default(true)
  type        String     @default("image")
  workspaceId String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([productId])
  @@index([workspaceId])
}

model GallerySubmission {
  id              String     @id @default(cuid())
  urls            Json
  sku             String?
  productName     String?
  status          String     @default("pending")
  notes           String?
  productId       String?
  selectedIndices Json?
  workspaceId     String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  workspace       Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([status])
  @@index([workspaceId])
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  name           String?
  role           Role       @default(USER)
  status         String     @default("ACTIVE") // ACTIVE, DISABLED
  permissions    Json?      @default("{}")
  workspaceId    String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  workspace      Workspace? @relation("WorkspaceMembers", fields: [workspaceId], references: [id])
  ownedWorkspace Workspace? @relation("WorkspaceOwner")
}

model EmailWhitelist {
  id                String   @id @default(cuid())
  email             String   @unique
  role              Role     @default(USER)
  permissions       Json?    @default("{}")
  targetWorkspaceId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, code])
}

model SystemSetting {
  id                     String     @id @default(cuid())
  workspaceId            String?
  lowStockThreshold      Int        @default(10)
  allowDataImport        Boolean    @default(true)
  allowGalleryUpload     Boolean    @default(true)
  storageType            String     @default("local")
  minioEndpoint          String?
  minioPort              Int?
  minioAccessKey         String?
  minioSecretKey         String?
  minioBucket            String?
  minioUseSSL            Boolean    @default(true)
  minioPublicUrl         String?
  uploadConflictStrategy String     @default("hash")
  lastBackup             DateTime?
  updatedAt              DateTime   @updatedAt
  workspace              Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model BrushOrder {
  id              String           @id @default(cuid())
  date            DateTime         @default(now())
  type            String
  status          String           @default("Draft")
  principalAmount Float            @default(0)
  paymentAmount   Float            @default(0)
  receivedAmount  Float            @default(0)
  commission      Float            @default(0)
  note            String?
  workspaceId     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  workspace       Workspace?       @relation(fields: [workspaceId], references: [id])
  items           BrushOrderItem[]

  @@index([workspaceId])
}

model BrushOrderItem {
  id           String     @id @default(cuid())
  brushOrderId String
  productId    String
  quantity     Int        @default(1)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  brushOrder   BrushOrder @relation(fields: [brushOrderId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id])
}
